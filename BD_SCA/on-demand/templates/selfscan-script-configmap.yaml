apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "selfscan.name" . }}-script
  namespace: {{ .Values.target.namespace | default .Release.Namespace }}
data:
  run.sh: |
    #!/bin/sh
    set -euo pipefail

    echo "[selfscan] Starting Black Duck selfscan job"
    echo "[selfscan] Target namespace ${TARGET_NS}"
    echo "[selfscan] Label selector ${LABEL_SELECTOR}"
    echo "[selfscan] Inspector URL ${INSPECTOR_URL}"

    echo "[selfscan] Installing tools..."
    apk add --no-cache curl jq skopeo openjdk17-jre coreutils bash >/dev/null 2>&1

    echo "[selfscan] Installing kubectl..."
    KV=$(curl -sSL https://dl.k8s.io/release/stable.txt)
    curl -fsSL -o /usr/local/bin/kubectl "https://dl.k8s.io/release/${KV}/bin/linux/amd64/kubectl"
    chmod +x /usr/local/bin/kubectl

    # Verify the secret exists and has the expected keys
    echo "[selfscan] Verifying Black Duck credentials secret..."
    if kubectl get secret blackduck-creds -n ${TARGET_NS} >/dev/null 2>&1; then
      echo "[selfscan] Secret 'blackduck-creds' exists"
      kubectl get secret blackduck-creds -n ${TARGET_NS} -o jsonpath='{.data}' | jq 'keys'
    else
      echo "[selfscan] ERROR: Secret 'blackduck-creds' not found in namespace ${TARGET_NS}"
      exit 1
    fi

    # Configure registry authentication if provided
    if [ -n "${REGISTRY_SECRET_PATH:-}" ] && [ -d "${REGISTRY_SECRET_PATH}" ]; then
      echo "[selfscan] Configuring registry authentication..."
      mkdir -p ~/.docker
      if [ -f "${REGISTRY_SECRET_PATH}/.dockerconfigjson" ]; then
        cp "${REGISTRY_SECRET_PATH}/.dockerconfigjson" ~/.docker/config.json
      fi
    fi

    echo "[selfscan] Waiting for Black Duck URL to respond ${BD_URL}"
    for i in $(seq 1 60); do
      if curl -sk --max-time 10 "${BD_URL}/api/current-version" >/dev/null 2>&1; then
        echo "[selfscan] Black Duck is reachable"
        break
      fi
      echo "[selfscan] Black Duck not reachable yet, retrying in 5s..."
      sleep 5
      if [ $i -eq 60 ]; then
        echo "[selfscan] ERROR Black Duck is not reachable after 5 minutes"
        exit 1
      fi
    done

    echo "[selfscan] Waiting for Image Inspector service ${INSPECTOR_URL}"
    for i in $(seq 1 30); do
      if curl -sk --max-time 5 "${INSPECTOR_URL}/health" >/dev/null 2>&1; then
        echo "[selfscan] Image Inspector is ready"
        break
      fi
      echo "[selfscan] Image Inspector not ready yet, retrying in 10s..."
      sleep 10
      if [ $i -eq 30 ]; then
        echo "[selfscan] ERROR Image Inspector is not ready after 5 minutes"
        exit 1
      fi
    done

    # Debug environment variables
    echo "[selfscan] Debugging environment variables..."
    echo "[selfscan] BD_URL is set: $([ -n "${BD_URL}" ] && echo "YES" || echo "NO")"
    echo "[selfscan] BD_TOKEN is set: $([ -n "${BD_TOKEN}" ] && echo "YES" || echo "NO")"
    if [ -n "${BD_URL}" ]; then
      echo "[selfscan] BD_URL length: ${#BD_URL} characters"
    fi
    if [ -n "${BD_TOKEN}" ]; then
      echo "[selfscan] BD_TOKEN length: ${#BD_TOKEN} characters"
    fi

    # Download Detect BEFORE using it
    DETECT=/tmp/detect.sh
    echo "[selfscan] Downloading Black Duck Detect..."
    curl -fsSL https://detect.blackduck.com/detect10.sh -o "${DETECT}"
    chmod +x "${DETECT}"

    echo "[selfscan] âœ… Black Duck connectivity verified (credentials and URL are working)"

    echo "[selfscan] Discovering images in namespace=${TARGET_NS}, selector=${LABEL_SELECTOR}"
    PODS_JSON=$(kubectl -n "${TARGET_NS}" get pods -l "${LABEL_SELECTOR}" -o json 2>/dev/null || echo '{"items":[]}')

    if [ "$(echo "${PODS_JSON}" | jq '.items | length')" -eq 0 ]; then
      echo "[selfscan] No pods found matching selector; exiting successfully"
      exit 0
    fi

    IMAGES=$(echo "${PODS_JSON}" | jq -r '
      [
        (.items[].spec.containers[]?.image),
        (.items[].spec.initContainers[]?.image)
      ] | map(select(. != null)) | unique[]' 2>/dev/null || echo "")

    if [ -z "${IMAGES}" ]; then
      echo "[selfscan] No container images found; exiting successfully"
      exit 0
    fi

    echo "[selfscan] Found images"
    echo "${IMAGES}" | sed 's/^/  - /'

    # Derive parent project/version with better logic
    if [ -n "${DETECT_PARENT_PROJECT}" ]; then
      PARENT_PROJECT="${DETECT_PARENT_PROJECT}"
    else
      # Try to extract from label selector
      PARENT_PROJECT=$(echo "${LABEL_SELECTOR}" | sed -n 's/.*app=\([^,]*\).*/\1/p' | head -1)
      if [ -z "${PARENT_PROJECT}" ]; then
        PARENT_PROJECT=$(echo "${LABEL_SELECTOR}" | sed -n 's/.*app\.kubernetes\.io\/name=\([^,]*\).*/\1/p' | head -1)
      fi
      if [ -z "${PARENT_PROJECT}" ]; then
        PARENT_PROJECT="kubernetes-scan"
      fi
    fi

    if [ -n "${DETECT_PARENT_VERSION}" ]; then
      PARENT_VERSION="${DETECT_PARENT_VERSION}"
    else
      # Try multiple label patterns for version
      PARENT_VERSION=$(echo "${PODS_JSON}" | jq -r '.items[0].metadata.labels.version // .items[0].metadata.labels["app.kubernetes.io/version"] // empty' 2>/dev/null || echo "")
      if [ -z "${PARENT_VERSION}" ]; then
        PARENT_VERSION="current"
      fi
    fi

    echo "[selfscan] Parent project ${PARENT_PROJECT}"
    echo "[selfscan] Parent version ${PARENT_VERSION}"

    # Create base Detect properties using echo instead of heredoc
    echo "blackduck.url=${BD_URL}" > /tmp/base.props
    echo "blackduck.api.token=${BD_TOKEN}" >> /tmp/base.props
    echo "blackduck.trust.cert=${TRUST_CERT}" >> /tmp/base.props
    echo "detect.wait.for.results=true" >> /tmp/base.props
    echo "detect.cleanup=false" >> /tmp/base.props
    echo "detect.tools=DOCKER" >> /tmp/base.props
    echo "detect.docker.passthrough.imageinspector.service.url=${INSPECTOR_URL}" >> /tmp/base.props
    echo "detect.docker.passthrough.imageinspector.service.start=false" >> /tmp/base.props
    echo "detect.docker.passthrough.shared.dir.path.local=${SHARED_LOCAL}" >> /tmp/base.props
    echo "detect.docker.passthrough.shared.dir.path.imageinspector=${SHARED_REMOTE}" >> /tmp/base.props
    echo "logging.level.com.synopsys.integration=DEBUG" >> /tmp/base.props

    if [ -n "${PROJECT_GROUP}" ]; then
      echo "detect.project.group.name=${PROJECT_GROUP}" >> /tmp/base.props
    fi

    # Ensure shared directory exists
    mkdir -p "${SHARED_LOCAL}/target"
    FAILED_IMAGES=""
    SUCCESS_COUNT=0
    TOTAL_COUNT=0

    echo "${IMAGES}" | while read -r IMAGE; do
      [ -z "${IMAGE}" ] && continue
      TOTAL_COUNT=$((TOTAL_COUNT + 1))

      echo "=============================================="
      echo "[selfscan] Processing image ${TOTAL_COUNT} - ${IMAGE}"

      # Extract repository and tag/digest info
      REPO=$(printf "%s" "${IMAGE}" | cut -d@ -f1 | cut -d: -f1)
      MICROSVC=$(basename "${REPO}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

      # Determine version name
      if echo "${IMAGE}" | grep -q '@sha256'; then
        # Image specified by digest
        DIGEST=$(echo "${IMAGE}" | cut -d@ -f2)
        SHORT_DIGEST=$(echo "${DIGEST}" | cut -c8-19)
        VERSION_NAME="digest-${SHORT_DIGEST}"
      elif echo "${IMAGE}" | grep -q ':'; then
        # Image specified by tag
        TAG=$(echo "${IMAGE}" | cut -d: -f2- | cut -d@ -f1)
        VERSION_NAME="${TAG}"
      else
        # No tag specified, assume latest
        VERSION_NAME="latest"
      fi

      echo "[selfscan] Project ${MICROSVC} Version ${VERSION_NAME}"

      # Create image archive
      TAR="${SHARED_LOCAL}/target/${MICROSVC}-${VERSION_NAME}.tar"
      echo "[selfscan] Saving image to ${TAR}..."

      if ! skopeo copy --retry-times=3 "docker://${IMAGE}" "docker-archive:${TAR}:${IMAGE}"; then
        echo "[selfscan][ERROR] Failed to save image ${IMAGE}"
        FAILED_IMAGES="${FAILED_IMAGES} ${IMAGE}"
        continue
      fi

      # Create Detect run properties using echo instead of heredoc
      echo "detect.project.parent.name=${PARENT_PROJECT}" > /tmp/run.props
      echo "detect.project.parent.version.name=${PARENT_VERSION}" >> /tmp/run.props
      echo "detect.project.name=${MICROSVC}" >> /tmp/run.props
      echo "detect.project.version.name=${VERSION_NAME}" >> /tmp/run.props
      echo "detect.docker.tar=${TAR}" >> /tmp/run.props
      echo "detect.policy.check.fail.on.severities=${POLICY_FAIL_SEVS}" >> /tmp/run.props

      # Combine properties
      cat /tmp/base.props /tmp/run.props > /tmp/detect.props

      # Debug the detect.props file content
      echo "[selfscan] DEBUG: Contents of detect.props file:"
      cat /tmp/detect.props
      echo "[selfscan] DEBUG: End of detect.props file"

      echo "[selfscan] Running Detect for ${MICROSVC} ${VERSION_NAME}..."
      set +e
      # Try running Detect with individual parameters instead of properties file
      bash "${DETECT}" \
        --blackduck.url="${BD_URL}" \
        --blackduck.api.token="${BD_TOKEN}" \
        --blackduck.trust.cert="${TRUST_CERT}" \
        --detect.wait.for.results=true \
        --detect.cleanup=false \
        --detect.tools=DOCKER \
        --detect.docker.passthrough.imageinspector.service.url="${INSPECTOR_URL}" \
        --detect.docker.passthrough.imageinspector.service.start=false \
        --detect.docker.passthrough.shared.dir.path.local="${SHARED_LOCAL}" \
        --detect.docker.passthrough.shared.dir.path.imageinspector="${SHARED_REMOTE}" \
        --detect.project.parent.name="${PARENT_PROJECT}" \
        --detect.project.parent.version.name="${PARENT_VERSION}" \
        --detect.project.name="${MICROSVC}" \
        --detect.project.version.name="${VERSION_NAME}" \
        --detect.docker.tar="${TAR}" \
        --detect.policy.check.fail.on.severities="${POLICY_FAIL_SEVS}" \
        --logging.level.com.synopsys.integration=DEBUG
      DETECT_RC=$?
      set -e

      if [ $DETECT_RC -ne 0 ]; then
        echo "[selfscan][FAIL] Detect failed with exit code ${DETECT_RC} for ${IMAGE}"
        FAILED_IMAGES="${FAILED_IMAGES} ${IMAGE}"
      else
        echo "[selfscan][PASS] Successfully scanned ${IMAGE}"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
      fi

      # Clean up the tar file to save space
      rm -f "${TAR}"
    done

    echo "=============================================="
    echo "[selfscan] Scan Summary"
    echo "[selfscan] Total images ${TOTAL_COUNT}"
    echo "[selfscan] Successful ${SUCCESS_COUNT}"

    if [ -n "${FAILED_IMAGES}" ]; then
      echo "[selfscan] Failed images${FAILED_IMAGES}"
      echo "[selfscan] Some scans failed - marking job as failed"
      exit 1
    fi

    # Annotate workloads if requested
    if [ "${ANNOTATE}" = "true" ]; then
      echo "[selfscan] Annotating workloads with scan results..."
      for KIND in deployments statefulsets daemonsets; do
        kubectl -n "${TARGET_NS}" get ${KIND} -l "${LABEL_SELECTOR}" -o name 2>/dev/null | while read -r RES; do
          kubectl -n "${TARGET_NS}" annotate "${RES}" \
            "${ANNO_KEY}=${ANNO_VALUE}" \
            "blackduck.synopsys.com/parent=${PARENT_PROJECT}" \
            "blackduck.synopsys.com/parent-version=${PARENT_VERSION}" \
            "blackduck.synopsys.com/scan-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --overwrite 2>/dev/null || true
        done
      done
    fi

    echo "[selfscan] All images scanned successfully!"
